---
title: "Advancing public health and data science using INLA - Day 2"
author: "Janet van Niekerk (janet.vanNiekerk@kaust.edu.sa)"
output: html_document
date: "May 2024"
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "/Users/vanniej/Documents/GitHub/INLA-CDC_2023")

library("INLA")
library("DiagrammeR")
library("car")
library("ggpubr")
library("spdep")
library("RColorBrewer")
library("spatstat")
library("sp")
library("latticeExtra")
library("gridExtra")
library("gstat")
library("raster")
library("ggplot2")
library("ggfortify")
library("survival")
library("joineR")
library("BayesSurvival")
library("icenReg")
library("nloptr")
library("boot")
library("rnaturalearth")
library("leaflet")
```

## Spatial models for areal data

Intro to lattice and irregular lattice

## Example 1 - Besag and Besagproper models
```{r eval=FALSE, echo = TRUE}
inla.doc("besag")
```

In this example we use the North Carolina Sudden Infant Death Syndrome dataset.
```{r Example 1.a}
data(nc.sids)
head(nc.sids)
hist(nc.sids$SID74)
summary(nc.sids)
```
We see that the number of deaths is a count variable and therefore propose a Poisson regression model, i.e. 
$$y\sim Poi(E\theta)$$
with $$\theta = \exp(\eta)$$ and $E$ is the expected count. In this way, $\theta$ indicates the risk. We need to calculate the expected count for each observation,
```{r Example 1.b}
p_hat <- sum(nc.sids$SID74) / sum(nc.sids$BIR74)
nc.sids$E74 <- p_hat * nc.sids$BIR74
```
We use the NWBIR as a covariate to investigate if it has any influence on the risk of SIDS. We consider the proportion instead of the count,
```{r Example 1.c}
nc.sids$nwp_hat74 <- nc.sids$NWBIR74 / nc.sids$BIR74
```
Adding a random intercept adds an independent effect, although the counties are probably not independent in terms of socio-economic diversity. So we should rather include a structured random effect such that some "intercepts" are correlated with each other, conveying the dependence in space. Since we have space divided into discrete non-overlapping parts, we can use a Besag or BYM model.
```{r Example 1.d}
#Add besag for counties - a spatial model
#Graph - neighbourhood structure
nc.sids <- st_read(system.file("shapes/sids.shp", package="spData"))
nc.adj <- poly2nb(nc.sids)
B.nc <- nb2mat(nc.adj, style = "B")

plot(nc.sids$geometry, border="grey")
plot(nc.adj, coords = nc.sids$geometry,  add = TRUE, col = "blue")

#Add expected count and covariate to spatial dataset    
p_hat <- sum(nc.sids$SID74) / sum(nc.sids$BIR74)
nc.sids$E74 <- p_hat * nc.sids$BIR74
nc.sids$nwp_hat74 <- nc.sids$NWBIR74 / nc.sids$BIR74
nc.sids$CNTY_ID2 <- 1:(length(nc.sids$CNTY_ID))

#Fit the spatial model
result3_sids <- inla(SID74 ~ nwp_hat74 + f(CNTY_ID2, model = "besagproper", graph = B.nc), 
                     data = as.data.frame(nc.sids), 
                     family = "poisson",
                     control.predictor = list(compute = TRUE),
                     E = E74)
```
The posterior summary is
```{r Example 2.e}
summary(result3_sids)
```
The two extra hyperparameters from the BYM effect are the marginal standard deviation, $\sigma$ and the weight parameter, $\phi$, and their marginal posteriors are
```{r Example 2.f}
res3_sd_bym <- inla.tmarginal(function(x) sqrt(1/x), result3_sids$marginals.hyperpar$`Precision for CNTY_ID2`)
plot(res3_sd_bym, type = "l", xlab = expression(sigma), ylab = expression(paste("f(", sigma ,"|y)")))
```
We can again visually see the fit of the predictions from the model to the data,
```{r Example 2.g}
nc.sids$fit_besag <- result3_sids$summary.fitted.values$mean*nc.sids$E74
plot(nc.sids["SID74"], breaks = seq(0,50, by = 5), main = "Observed counts")
plot(nc.sids["fit_besag"], breaks = seq(0,50, by = 5), main = "Predicted counts")

plot(nc.sids$SID74)
points(nc.sids$E74*result1_sids$summary.fitted.values[,1], col = "blue", pch = 10)
points(nc.sids$E74*result2_sids$summary.fitted.values[,1], col = "red", pch = 19, cex = 0.5)
points(nc.sids$E74*result3_sids$summary.fitted.values[,1], col = "purple", pch = 8, cex = 0.8)
```
When we compare the fit between models we can look at the marginal log-likelihoods, DIC or WAIC.
```{r Example 2.h}
result1_sids <- inla(SID74 ~ nwp_hat74, data = nc.sids, 
                     family = "poisson",
                     control.compute = list(dic = TRUE, waic = TRUE),
                     control.predictor = list(compute = TRUE),
                     E = E74)

result2_sids <- inla(SID74 ~ nwp_hat74 + f(CNTY_ID2, model = "iid"), 
                     data = nc.sids, 
                     family = "poisson",
                     control.compute = list(dic = TRUE, waic = TRUE),
                     control.predictor = list(compute = TRUE),
                     E = E74)

result3_sids <- inla(SID74 ~ nwp_hat74 + f(CNTY_ID2, model = "besagproper", graph = B.nc), 
                     data = as.data.frame(nc.sids), 
                     family = "poisson",
                     control.compute = list(dic = TRUE, waic = TRUE),
                     control.predictor = list(compute = TRUE),
                     E = E74)

print(matrix(rbind(cbind(result1_sids$mlik[1], result1_sids$dic[1], result1_sids$waic[1]),
            cbind(result2_sids$mlik[1], result2_sids$dic[1], result2_sids$waic[1]),
            cbind(result3_sids$mlik[1], result3_sids$dic[1], result3_sids$waic[1])), 
            nrow = 3, ncol = 3,
            dimnames = list(c("Model 1", "Model 2", "Model 3"),
                            c("Marginal log-likelihood", "DIC", "WAIC")
                            )))
```

## Example 2 - BYM and BYM2 models
```{r eval=FALSE, echo = TRUE}
inla.doc("bym")
inla.doc("bym2")
```
Let's revisit the NC SIDS dataset example.  
Now we add a BYM effect for the different counties,
```{r Example 2.e}
result4_sids <- inla(SID74 ~ nwp_hat74 + f(CNTY_ID2, model = "bym2", graph = B.nc), 
                     data = as.data.frame(nc.sids), 
                     family = "poisson",
                     control.compute = list(dic = TRUE, waic = TRUE),
                     control.predictor = list(compute = TRUE),
                     E = E74)
```
The posterior summary is
```{r Example 2.f}
summary(result4_sids)
```
The two extra hyperparameters from the BYM effect are the marginal standard deviation, $\sigma$ and the weight parameter, $\phi$, and their marginal posteriors are
```{r Example 2.g}
res4_sd_bym <- inla.tmarginal(function(x) sqrt(1/x), result4_sids$marginals.hyperpar$`Precision for CNTY_ID2`)
plot(res4_sd_bym, type = "l", xlab = expression(sigma), ylab = expression(paste("f(", sigma ,"|y)")))
plot(result4_sids$marginals.hyperpar$`Phi for CNTY_ID2`, type = "l", xlab = expression(phi), ylab = expression(paste("f(", phi ,"|y)")))
```
We can again visually see the fit of the predictions from the model to the data,
```{r Example 2.h}
nc.sids$fit_bym <- result4_sids$summary.fitted.values$mean*nc.sids$E74
plot(nc.sids["SID74"],
       breaks = seq(0, 50, by = 5),
     main = "Observed counts")
plot(nc.sids["fit_bym"],
       breaks = seq(0, 50, by = 5),
     main = "Predicted counts")

plot(nc.sids$SID74)
points(nc.sids$E74*result1_sids$summary.fitted.values[,1], col = "blue", pch = 10)
points(nc.sids$E74*result2_sids$summary.fitted.values[,1], col = "red", pch = 19, cex = 0.5)
points(nc.sids$E74*result3_sids$summary.fitted.values[,1], col = "purple", pch = 8, cex = 0.8)
points(nc.sids$E74*result4_sids$summary.fitted.values[,1], col = "darkgreen", pch = 2, cex = 0.8)
```
When we compare the fit between models we can look at the marginal log-likelihoods, DIC or WAIC.
```{r Example 2.i}

print(matrix(rbind(cbind(result1_sids$mlik[1], result1_sids$dic[1], result1_sids$waic[1]),
            cbind(result2_sids$mlik[1], result2_sids$dic[1], result2_sids$waic[1]),
            cbind(result3_sids$mlik[1], result3_sids$dic[1], result3_sids$waic[1]),
            cbind(result4_sids$mlik[1], result4_sids$dic[1], result4_sids$waic[1])), 
            nrow = 4, ncol = 3,
            dimnames = list(c("Model 1", "Model 2 - iid", "Model 3 - Besag", "Model 4 - BYM"),
                            c("Marginal log-likelihood", "DIC", "WAIC")
                            )))
```
We can also do cross-validation as a means of measuring prediction performance. 

## Example 3 - Joint disease mapping models (using Besag2 model)
```{r pre}
# read data 
merg.data <- readRDS("Data/MAP_data.RDS")

# The map 
map <- ne_countries(returnclass = "sf")

# Extract the map and compile the shape
if (T){
names(map)[names(map) == "iso_a3"] <- "ISO3"
names(map)[names(map) == "name"] <- "NAME"
map <- map[order(map$name_long),]
map$name_long[157] <- "Gambia"
map$name_long[131] <- "Congo"

map <- map[order(map$name_long),]

# Select only the common countries from the map
sub_map <- match(map$name_long , merg.data$Common.countries)
map$cc <- sub_map
map_2 <- subset(map,map$cc!="NA" )
map_2 <- map_2[order(map_2$name_long),]

Our_index <- match(map$name_long , merg.data$Common.countries)

map_2$D.E = merg.data$D.E
map_2$M.E = merg.data$M.E
map_2$M.cases = merg.data$M.cases
map_2$D.cases = merg.data$D.cases
map_2$M.pop = merg.data$M.pop
map_2$D.pop = merg.data$D.pop


library(cleangeo)
rr <- clgeo_CollectionReport(map_2)
summary(rr)
issues <- rr[rr$type == NA,]
map_2_c <- clgeo_Clean(map_2)
}

# Neighbourhood graph
nb <- poly2nb(map_2_c)
nb2INLA("Day 2/map.adj", nb)
g <- inla.read.graph(filename = "Day 2/map.adj")

# Joint mean model




alpha = 0.2
r.m <- inla(formula = map_2$M.cases ~ 1 + offset(log(map_2$M.E)) +
              f(b1,model = "bym2", scale.model = T,
                graph = g)   ,
            family = "poisson",
            data =  merg.data,
            control.predictor = list(compute = T),
            control.compute = list(dic = T, waic = T, cpo = T),
            control.family = list(control.link = list(model = "quantile",
                                                      quantile = alpha)),
            verbose = TRUE)


#Summary
round(r.m$summary.hyperpar[,c(1,3,5,6)],3)


# the quantile for G6PD only

alpha = 0.8
r.d <- inla(formula = map_2$D.cases ~ 1 + offset(log(map_2$D.E))+
              f(b2,model = "bym2", scale.model = T,
                graph = g)  ,
            family = "poisson",
            data =  merg.data,
            control.predictor = list(compute = T),
            control.compute = list(dic = T, waic = T, cpo = T),
            control.family = list(control.link = list(model = "quantile",
                                                      quantile = alpha)),
            verbose = TRUE)



round(r.d$summary.hyperpar[,c(1,3,5,6)],3)


# The joint quantile 

b = length(merg.data$M.cases)
y1 = c(merg.data$M.cases , rep(NA,b))
y2 = c(rep(NA,b) , merg.data$D.cases)


E1 = c(merg.data$M.E,rep(NA,b))
E2 = c(rep(NA,b) , merg.data$D.E)

yy = cbind(y1,y2)
EE = cbind(E1, E2)
mu = c(rep(1, b) , rep(2,b))
b1 = c(1:b,rep(NA ,b))
b2= c(rep(NA,b),1:b)

besagproper = c(1:b , rep(NA ,b))

Besag.c = c(rep(NA , b), 1:b)

m = as.factor(mu)
d = data.frame(yy, m , besagproper , Besag.c,b1,b2)  


formula = yy ~ -1 +m + offset(log(E1))+ offset(log(E2))+
  f(besagproper, model = "besagproper", graph=g)+
  f(Besag.c, copy="besagproper", hyper = list(beta = list(fixed = FALSE)))+
  f(b1 , model = "bym2", graph=g, scale.model=TRUE)+
  f(b2, model = "bym2", graph=g, scale.model=TRUE)




alpha = 0.2
r1 <- inla(formula,
           family = c("poisson","poisson"),
           
           control.family = list(list(control.link = list(model = "quantile",quantile = alpha)),
                                 
                                 list(control.link = list(model = "quantile",
                                                          quantile = 1-alpha))), 
           # E = EE,
           data = d,
           verbose = F,
           control.compute = list(dic = T, waic = T, cpo = T),
           control.predictor = list(compute = T),
           inla.mode = "experimental")


round(r1$summary.fixed[,c(1:3,5)],3)

round(r1$summary.hyperpar[,c(1,3,5,6)],3)

r1$dic$dic
r1$waic$waic


r1a <- inla(formula,
           family = c("poisson","poisson"),
           control.family = list(list(control.link = list(model = "quantile",quantile = 0.8)),
                                 list(control.link = list(model = "quantile",
                                                          quantile = 0.3))),
           data = d,
           verbose = F,
           control.compute = list(dic = T, waic = T, cpo = T),
           control.predictor = list(compute = T),
           inla.mode = "experimental")


round(r1a$summary.fixed[,c(1:3,5)],3)

round(r1a$summary.hyperpar[,c(1,3,5,6)],3)

r1a$dic$dic
r1a$waic$waic

##Joint mean
r2 <- inla(formula,
           family = c("poisson","poisson"),
           data = d,
           verbose = F,
           control.compute = list(dic = T, waic = T, cpo = T),
           control.predictor = list(compute = T),
           inla.mode = "experimental")


round(r2$summary.fixed[,c(1:3,5)],3)

round(r2$summary.hyperpar[,c(1,3,5,6)],3)

r2$waic$waic
r2$dic$dic







# the iid EFFECT malaria

map_2$vm = (r.m$summary.random$b1$mean[1:21] * sqrt(r.m$summary.hyperpar$mode[1]) -  
             r.m$summary.random$b1$mean[22:42] * sqrt(r.m$summary.hyperpar$mode[2])) / 
  sqrt(1 - r.m$summary.hyperpar$mode[2])

map_2$um = r.m$summary.random$b1$mean[22:42] 

range(map_2$vm)


l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", 
                    domain = seq(-5.6,2.6 , by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$vm), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~seq(-5.6,2.6 , by = 0.1), 
            opacity = 0.5, title = "IID effect for Malaria",
            position = "topright")

# the iid EFFECT g6

map_2$vd2 = (r.d$summary.random$b2$mean[1:21] * sqrt(r.d$summary.hyperpar$mode[1]) -  
              r.d$summary.random$b2$mean[22:42] * sqrt(r.d$summary.hyperpar$mode[2])) / 
  sqrt(1 - r.d$summary.hyperpar$mode[2])

library(leaflet)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain = seq(-5.6,2.6 , by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$vd2), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~seq(-5.6,2.6 , by = 0.1), 
            opacity = 0.5, title = "IID effect for G6PD",
            position = "topright")



# the spatial effect for malaria

map_2$u.m2 = r.m$summary.random$b1$mean[22:42]

library(leaflet)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain = seq(-5.6,2.6 , by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$u.m2), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~seq(-5.6,2.6 , by = 0.1), 
            opacity = 0.5, title = "Besag effect for Malaria",
            position = "topright")

# the spatial effect for G6PD

map_2$u.d2 = r.d$summary.random$b2$mean[22:42]

range(map_2$u.d2)


library(leaflet)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(-5.6,2.6 , by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$u.d2), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(-5.6,2.6 , by = 0.1), 
            opacity = 0.5, title = "Besag effect for G6PD",
            position = "topright")

mean(abs(map_2$iid))
mean(abs(map_2$u.m2))

range(map_2$iid2)
range(map_2$u.d2)





# The relative risk for malaria 

map_2$rrm = r.m$summary.fitted.values[,"mean"]/map_2$M.E
range(map_2$rrm)

library(leaflet)

l <- leaflet(map_2) %>% addTiles()
pal <- colorNumeric(palette = "YlOrRd", 
                    domain = seq(0,6.3 , by = 0.1))
l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$rrm), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~seq(0,6.3 , by = 0.1), 
            opacity = 0.5, title = "RR",
            position = "topright")


# The realtive risk for G6PD

map_2$rrd = r.d$summary.fitted.values[,"mean"]/map_2$D.E
range(map_2$rrd)

library(leaflet)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(0, 6.3, length = 9))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$rrd), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(0, 6.3, length = 9), 
            opacity = 0.5, title = "RR",
            position = "topright")

# The predicted cases fr Malaria 

map_2$Predicted.MM = r.m$summary.fitted.values$mean
range(map_2$Predicted.MM)


library(leaflet)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(0,40000, length =9))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$Predicted.MM), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(0,40000, length =9), 
            opacity = 0.5, title = "Predicted",
            position = "topright")


#Observed

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(0,40000, length =9))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$M.cases), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(0,40000, length =9), 
            opacity = 0.5, title = "Observed",
            position = "topright")




# The predected cases for G6PD


map_2$Predicted.DD = r.d$summary.fitted.values$mean
range(map_2$Predicted.DD)


library(leaflet)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(0,500 , by = 10))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$Predicted.DD), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(0,500 , by = 10), 
            opacity = 0.5, title = "Predicted",
            position = "topright")



#Observed

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(0,500, length =9))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$D.cases), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(0,500, length =9), 
            opacity = 0.5, title = "Observed",
            position = "topright")

# iid effect for malaria

map_2$vmq = (r1$summary.random$b1$mean[1:21] * sqrt(r1$summary.hyperpar$mode[3]) -  
             r1$summary.random$b1$mean[22:42] * sqrt(r1$summary.hyperpar$mode[4])) / 
  sqrt(1 - r1$summary.hyperpar$mode[4])

range(map_2$vmq)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain = seq(-5.6,2.6 , by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$vmq), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~seq(-5.6,2.6 , by = 0.1), 
            opacity = 0.5, title = "IID",
            position = "topright")


# iid effect for g6pd

map_2$v = (r1$summary.random$b2$mean[1:21] * sqrt(r1$summary.hyperpar$mode[5]) -  
              r1$summary.random$b2$mean[22:42] * sqrt(r1$summary.hyperpar$mode[6])) / 
              sqrt(1 - r1$summary.hyperpar$mode[6])

range(map_2$v)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain = seq(-5.6,2.6 , by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$v), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~seq(-5.6,2.6 , by = 0.1), 
            opacity = 0.5, title = "IID",
            position = "topright")

# The shared component for Malaria 

map_2$sharedqm = r1$summary.random$besagproper$mean
range(map_2$sharedqm)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(-1.5,0.8 , by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$sharedqm), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(-1.5,0.8 , by = 0.1), 
            opacity = 0.5, title = "Shared effect",
            position = "bottomleft")


# The shared component for G6PD

map_2$sharedqd = r1$summary.random$Besag.c$mean
range(map_2$sharedqd)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(-5.6,2.6 , by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$sharedqd), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(-5.6,2.6 , by = 0.1), 
            opacity = 0.5, title = "Shared  effect",
            position = "bottomleft")


# The spatial effect for Malaria from joint 


map_2$sjm = r1$summary.random$b1$mean[22:42]

range(map_2$sjm)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(-1,0.5 , by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$sjm), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~seq(-1,0.5 , by = 0.1), 
            opacity = 0.5, title = "Besag",
            position = "topright")



# The spatial effect for G6PD from joint 

map_2$sjg = r1$summary.random$b2$mean[22:42]

range(map_2$sjg)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(-5.6,2.6 , by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$sjg), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(-5.6,2.6 , by = 0.1), 
            opacity = 0.5, title = "Besag",
            position = "topright")





# Posterior means of the total spatial effect for Malaria (quntile)


map_2$tsmq = r1$summary.random$b1$mean[22:42]+r1$summary.random$besagproper$mean

range(map_2$tsmq) 

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(-5.6,2.6 , by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$tsmq), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(-5.6,2.6 , by = 0.1), 
            opacity = 0.5, title = " Total spatial effect",
            position = "topright")




# Posterior means of the total spatial effect for g6pd (quntile)

map_2$tsgq = r1$summary.random$b2$mean[22:42]+r1$summary.random$Besag.c$mean

range(map_2$tsgq) 


l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(-5.6,2.6 , by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$tsgq ), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(-5.6,2.6 , by = 0.1), 
            opacity = 0.5, title = " Total spatial effect",
            position = "topright")


# RR for malaria from joint quantile 



map_2$rrjm = r1$summary.fitted.values[1:21, "mean"]/map_2$M.E

range(map_2$rrjm) 

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(0,6.3, by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$rrjm), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(0,6.3, by = 0.1), 
            opacity = 0.5, title = "RR",
            position = "topright")

# rr from joint for d

map_2$rrjd = r1$summary.fitted.values[22:42, "mean"]/map_2$D.E

range(map_2$rrjd) 



l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(0,6.3, by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$rrjd), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(0,6.3, by = 0.1), 
            opacity = 0.5, title = "RR",
            position = "topright")




# The predicted cases for m from joint




map_2$pm = r1$summary.fitted.values$mean[1:21]

range(map_2$pm) 


library(leaflet)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(0,40000, length =9))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$pm), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(0,40000, length =9), 
            opacity = 0.5, title = "Predicted",
            position = "topright")


l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(0,40000, length =9))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$M.cases), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(0,40000, length =9), 
            opacity = 0.5, title = "Observed",
            position = "topright")


# The predicted cases for d from joint


map_2$pd = r1$summary.fitted.values$mean[22:42]
range(map_2$pd) 

# map_2$pd1 = exp(r$summary.linear.predictor$mean[22:42])
# range(map_2$pd1)

library(leaflet)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(0,500, length =9))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$pd), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(0,500, length =9), 
            opacity = 0.5, title = "Predicted",
            position = "topright")

#Observed

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(0,500, length =9))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$D.cases), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(0,500, length =9), 
            opacity = 0.5, title = "Observed",
            position = "topright")


# bym malaria from joint 

map_2$bymmq = r1$summary.random$b1$mean[1:21]

range(map_2$bymmq)


library(leaflet)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain = seq(-5.6,2.6 , by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$bymmq), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~seq(-5.6,2.6 , by = 0.1), 
            opacity = 0.5, title = "BYM effect for Malaria",
            position = "bottomleft")





# bym g6pd from joint 

map_2$bymgq = r1$summary.random$b2$mean[1:21]

range(map_2$bymgq)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain = seq(-5.6,2.6 , by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$bymgq), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~seq(-5.6,2.6 , by = 0.1), 
            opacity = 0.5, title = "BYM effect for G6PD",
            position = "topright")



```


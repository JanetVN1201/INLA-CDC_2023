---
title: "Advancing public health and data science using INLA - Day 2"
author: "Janet van Niekerk (janet.vanNiekerk@kaust.edu.sa)"
output: html_document
date: "May 2024"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("INLA")
library("DiagrammeR")
library("car")
library("ggpubr")
library("spdep")
library("RColorBrewer")
library("spatstat")
library("rgdal")
library("sp")
library("maptools")
library("latticeExtra")
library("gridExtra")
library("gstat")
library("raster")
library("ggplot2")
library("ggfortify")
library("survival")
library("joineR")
#library("bayesSurv")
library("BayesSurvival")
library("icenReg")
library("nloptr")
library("faraway")
library("lme4")
library("boot")
library("rnaturalearth")
library("leaflet")
```

## Spatial models for areal data

Intro to lattice and irregular lattice

## Example 1 - Besag and Besagproper models
```{r eval=FALSE, echo = TRUE}
inla.doc("besag")
```

## Example 2 - BYM and BYM2 models
```{r eval=FALSE, echo = TRUE}
inla.doc("bym")
```

## Example 3 - Flexible Besag models (nonstationary Besag)
Esmail's work

## Example 4 - Joint disease mapping models (using Besag2 model)
```{r pre}
# read data 
md= read.csv("~/Google Drive/My Drive/KAUST/Research/Quantile-regression/real data quantile/G6PD.csv", header = TRUE) 

# select few columns

md$number_males[is.na(md$number_males)]<-0



md$number_females[is.na(md$number_females)]<-0
md$number_males_deficient[is.na(md$number_males_deficient)]<-0
md$number_females_deficient[is.na(md$number_females_deficient)]<-0

md1 = data.frame(country = md$country)


# The total number of people
md1$population =md$number_females+md$number_males


# The total number of the cases
md1$cases = md$number_females_deficient+md$number_males_deficient



md2<-md1
# aggregate data
md3 <- aggregate(
  x = md2$cases  ,
  by = list(country = md2$country),
  FUN = sum
)


md4 <- aggregate(
  x = md2$population  ,
  by = list(country = md2$country),
  FUN = sum
)

# the expected value
md3$pop <- md4$x
overall_rate = sum(md3$x)/sum(md3$pop)

md3$E <- overall_rate*md3$pop
#md4 = subset(md3, md3$E!=0)
head(md3)


# Malaria disease data

# read data 
mdd= read.csv("~/Google Drive/My Drive/KAUST/Research/Quantile-regression/real data quantile/public_pf.csv", header = TRUE) 







mdd$examined[is.na(mdd$examined)]<-0
mdd$pf_pos[is.na(mdd$pf_pos)]<-0


mdd1 = data.frame(country = mdd$country,population2 = mdd$examined,cases2 = mdd$pf_pos)

#mdd1$country[mdd1$country == "Democratic Republic of the Congo"] <- "Congo" I find and replace in the excel 






mdd2<-mdd1

# aggregate data
mdd3 <- aggregate(
  x = mdd2$cases2  ,
  by = list(country = mdd2$country),
  FUN = sum
)

mdd4 <- aggregate(
  x = mdd2$population2  ,
  by = list(country = mdd2$country),
  FUN = sum
)

# the expected value
mdd3$pop <- mdd4$x

overall_rate = sum(mdd3$x)/sum(mdd3$pop)


mdd3$E <- overall_rate*mdd3$pop

#mdd4 <- subset(mdd3, mdd3$E!="NA")

head(mdd3)

# Merge data 

mddd3 = merge(mdd3, md3, by = "country")

mddd3 = mddd3[order(mddd3$country),]


mddd3 = mddd3[c(-1,-3, -4,-5,-7,-8,-9,-11,-14,-19,-20,-21,-25,-27,-29,-30,-32,
                -33,-34,-35,-36,-38,-39,-41,-42,-44,-46,-47),] # I delete the "Cape Verde" country becuase it is not in the 
Common.countries = mddd3$country
length(Common.countries)

mddd3 = mddd3[order(mddd3$country),]

merg.data = data.frame(country = mddd3$country , M.cases = mddd3$x.x ,M.pop = mddd3$pop.x ,M.E = mddd3$E.x,
                       D.cases = mddd3$x.y , D.pop = mddd3$pop.y , D.E = mddd3$E.y ,
                       b1 = 1:length(mddd3$x.y), b2 = 1:length(mddd3$x.y), ID = 1:length(mddd3$x.y))



merg.data$SMRm = merg.data$M.cases / merg.data$M.E

merg.data$SMRg = merg.data$D.cases / merg.data$D.E
merg.data <- merg.data[order(merg.data$country),]




exp(sum(merg.data$M.cases) /sum(merg.data$M.pop))


sum(merg.data$M.pop) /sum(merg.data$M.cases)

sum(merg.data$D.pop) /sum(merg.data$D.cases)

mean(merg.data$M.cases)


head(merg.data)

# The map 
map <- ne_countries(returnclass = "sf")
names(map)[names(map) == "iso_a3"] <- "ISO3"
names(map)[names(map) == "name"] <- "NAME"
map <- map[order(map$name_long),]
map$name_long[157] <- "Gambia"
map$name_long[131] <- "Congo"

map <- map[order(map$name_long),]

# Select only the common countries from the map

sub_map <- match(map$name_long , Common.countries)
map$cc <- sub_map
map_2 <- subset(map,map$cc!="NA" )
map_2 <- map_2[order(map_2$name_long),]

Our_index <- match(map$name_long , Common.countries)


map_2$D.E = merg.data$D.E
map_2$M.E = merg.data$M.E
map_2$M.cases = merg.data$M.cases
map_2$D.cases = merg.data$D.cases
map_2$M.pop = merg.data$M.pop
map_2$D.pop = merg.data$D.pop


library(cleangeo)
rr <- clgeo_CollectionReport(map_2)
summary(rr)
issues <- rr[rr$type == NA,]
map_2_c <- clgeo_Clean(map_2)

nb <- poly2nb(map_2_c)
nb2INLA("map.adj", nb)
g <- inla.read.graph(filename = "map.adj")



alpha = 0.2
r.m <- inla(formula = map_2$M.cases ~ 1 + offset(log(map_2$M.E)) +
              f(b1,model = "bym2", scale.model = T,
                graph = g)   ,
            family = "poisson",
            # offset = log(map_2$M.E),
            #E = map_2$M.E,
            data =  merg.data,
            control.predictor = list(compute = T),
            control.compute = list(dic = T, waic = T, cpo = T),
            control.family = list(control.link = list(model = "quantile",
                                                      quantile = alpha)),
            verbose = TRUE)



round(r.m$summary.hyperpar[,c(1,3,5,6)],3)


# the quantile for G6PD only

alpha = 0.8
r.d <- inla(formula = map_2$D.cases ~ 1 + offset(log(map_2$D.E))+
              f(b2,model = "bym2", scale.model = T,
                graph = g)  ,
            family = "poisson",
            data =  merg.data,
            control.predictor = list(compute = T),
            control.compute = list(dic = T, waic = T, cpo = T),
            control.family = list(control.link = list(model = "quantile",
                                                      quantile = alpha)),
            verbose = TRUE)



round(r.d$summary.hyperpar[,c(1,3,5,6)],3)


# The joint quantile 

b = length(merg.data$M.cases)
y1 = c(merg.data$M.cases , rep(NA,b))
y2 = c(rep(NA,b) , merg.data$D.cases)


E1 = c(merg.data$M.E,rep(NA,b))
E2 = c(rep(NA,b) , merg.data$D.E)

yy = cbind(y1,y2)
EE = cbind(E1, E2)
mu = c(rep(1, b) , rep(2,b))
b1 = c(1:b,rep(NA ,b))
b2= c(rep(NA,b),1:b)

besagproper = c(1:b , rep(NA ,b))

Besag.c = c(rep(NA , b), 1:b)

m = as.factor(mu)
d = data.frame(yy, m , besagproper , Besag.c,b1,b2)  


formula = yy ~ -1 +m + offset(log(E1))+ offset(log(E2))+
  f(besagproper, model = "besagproper", graph=g)+
  f(Besag.c, copy="besagproper", hyper = list(beta = list(fixed = FALSE)))+
  f(b1 , model = "bym2", graph=g, scale.model=TRUE)+
  f(b2, model = "bym2", graph=g, scale.model=TRUE)




alpha = 0.2
r1 <- inla(formula,
           family = c("poisson","poisson"),
           
           control.family = list(list(control.link = list(model = "quantile",quantile = alpha)),
                                 
                                 list(control.link = list(model = "quantile",
                                                          quantile = 1-alpha))), 
           # E = EE,
           data = d,
           verbose = F,
           control.compute = list(dic = T, waic = T, cpo = T),
           control.predictor = list(compute = T),
           inla.mode = "experimental")


round(r1$summary.fixed[,c(1:3,5)],3)

round(r1$summary.hyperpar[,c(1,3,5,6)],3)

r1$dic$dic
r1$waic$waic


r1a <- inla(formula,
           family = c("poisson","poisson"),
           control.family = list(list(control.link = list(model = "quantile",quantile = 0.8)),
                                 list(control.link = list(model = "quantile",
                                                          quantile = 0.3))),
           data = d,
           verbose = F,
           control.compute = list(dic = T, waic = T, cpo = T),
           control.predictor = list(compute = T),
           inla.mode = "experimental")


round(r1a$summary.fixed[,c(1:3,5)],3)

round(r1a$summary.hyperpar[,c(1,3,5,6)],3)

r1a$dic$dic
r1a$waic$waic

##Joint mean
r2 <- inla(formula,
           family = c("poisson","poisson"),
           data = d,
           verbose = F,
           control.compute = list(dic = T, waic = T, cpo = T),
           control.predictor = list(compute = T),
           inla.mode = "experimental")


round(r2$summary.fixed[,c(1:3,5)],3)

round(r2$summary.hyperpar[,c(1,3,5,6)],3)

r2$waic$waic
r2$dic$dic







# the iid EFFECT malaria

map_2$vm = (r.m$summary.random$b1$mean[1:21] * sqrt(r.m$summary.hyperpar$mode[1]) -  
             r.m$summary.random$b1$mean[22:42] * sqrt(r.m$summary.hyperpar$mode[2])) / 
  sqrt(1 - r.m$summary.hyperpar$mode[2])

map_2$um = r.m$summary.random$b1$mean[22:42] 

range(map_2$vm)


l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", 
                    domain = seq(-5.6,2.6 , by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$vm), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~seq(-5.6,2.6 , by = 0.1), 
            opacity = 0.5, title = "IID effect for Malaria",
            position = "topright")

# the iid EFFECT g6

map_2$vd2 = (r.d$summary.random$b2$mean[1:21] * sqrt(r.d$summary.hyperpar$mode[1]) -  
              r.d$summary.random$b2$mean[22:42] * sqrt(r.d$summary.hyperpar$mode[2])) / 
  sqrt(1 - r.d$summary.hyperpar$mode[2])

library(leaflet)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain = seq(-5.6,2.6 , by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$vd2), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~seq(-5.6,2.6 , by = 0.1), 
            opacity = 0.5, title = "IID effect for G6PD",
            position = "topright")



# the spatial effect for malaria

map_2$u.m2 = r.m$summary.random$b1$mean[22:42]

library(leaflet)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain = seq(-5.6,2.6 , by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$u.m2), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~seq(-5.6,2.6 , by = 0.1), 
            opacity = 0.5, title = "Besag effect for Malaria",
            position = "topright")

# the spatial effect for G6PD

map_2$u.d2 = r.d$summary.random$b2$mean[22:42]

range(map_2$u.d2)


library(leaflet)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(-5.6,2.6 , by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$u.d2), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(-5.6,2.6 , by = 0.1), 
            opacity = 0.5, title = "Besag effect for G6PD",
            position = "topright")

mean(abs(map_2$iid))
mean(abs(map_2$u.m2))

range(map_2$iid2)
range(map_2$u.d2)





# The relative risk for malaria 

map_2$rrm = r.m$summary.fitted.values[,"mean"]/map_2$M.E
range(map_2$rrm)

library(leaflet)

l <- leaflet(map_2) %>% addTiles()
pal <- colorNumeric(palette = "YlOrRd", 
                    domain = seq(0,6.3 , by = 0.1))
l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$rrm), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~seq(0,6.3 , by = 0.1), 
            opacity = 0.5, title = "RR",
            position = "topright")


# The realtive risk for G6PD

map_2$rrd = r.d$summary.fitted.values[,"mean"]/map_2$D.E
range(map_2$rrd)

library(leaflet)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(0, 6.3, length = 9))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$rrd), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(0, 6.3, length = 9), 
            opacity = 0.5, title = "RR",
            position = "topright")

# The predicted cases fr Malaria 

map_2$Predicted.MM = r.m$summary.fitted.values$mean
range(map_2$Predicted.MM)


library(leaflet)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(0,40000, length =9))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$Predicted.MM), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(0,40000, length =9), 
            opacity = 0.5, title = "Predicted",
            position = "topright")


#Observed

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(0,40000, length =9))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$M.cases), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(0,40000, length =9), 
            opacity = 0.5, title = "Observed",
            position = "topright")




# The predected cases for G6PD


map_2$Predicted.DD = r.d$summary.fitted.values$mean
range(map_2$Predicted.DD)


library(leaflet)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(0,500 , by = 10))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$Predicted.DD), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(0,500 , by = 10), 
            opacity = 0.5, title = "Predicted",
            position = "topright")



#Observed

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(0,500, length =9))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$D.cases), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(0,500, length =9), 
            opacity = 0.5, title = "Observed",
            position = "topright")










# iid effect for malaria

map_2$vmq = (r1$summary.random$b1$mean[1:21] * sqrt(r1$summary.hyperpar$mode[3]) -  
             r1$summary.random$b1$mean[22:42] * sqrt(r1$summary.hyperpar$mode[4])) / 
  sqrt(1 - r1$summary.hyperpar$mode[4])

range(map_2$vmq)


library(leaflet)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain = seq(-5.6,2.6 , by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$vmq), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~seq(-5.6,2.6 , by = 0.1), 
            opacity = 0.5, title = "IID",
            position = "topright")


# iid effect for g6pd

map_2$v = (r1$summary.random$b2$mean[1:21] * sqrt(r1$summary.hyperpar$mode[5]) -  
              r1$summary.random$b2$mean[22:42] * sqrt(r1$summary.hyperpar$mode[6])) / 
              sqrt(1 - r1$summary.hyperpar$mode[6])

range(map_2$v)


library(leaflet)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain = seq(-5.6,2.6 , by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$v), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~seq(-5.6,2.6 , by = 0.1), 
            opacity = 0.5, title = "IID",
            position = "topright")








# The shared component for Malaria 

map_2$sharedqm = r1$summary.random$besagproper$mean
range(map_2$sharedqm)

library(leaflet)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(-1.5,0.8 , by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$sharedqm), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(-1.5,0.8 , by = 0.1), 
            opacity = 0.5, title = "Shared effect",
            position = "bottomleft")


# The shared component for G6PD

map_2$sharedqd = r1$summary.random$Besag.c$mean
range(map_2$sharedqd)

library(leaflet)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(-5.6,2.6 , by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$sharedqd), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(-5.6,2.6 , by = 0.1), 
            opacity = 0.5, title = "Shared  effect",
            position = "bottomleft")


# The spatial effect for Malaria from joint 


map_2$sjm = r1$summary.random$b1$mean[22:42]

range(map_2$sjm)

library(leaflet)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(-1,0.5 , by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$sjm), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~seq(-1,0.5 , by = 0.1), 
            opacity = 0.5, title = "Besag",
            position = "topright")



# The spatial effect for G6PD from joint 

map_2$sjg = r1$summary.random$b2$mean[22:42]

range(map_2$sjg)

library(leaflet)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(-5.6,2.6 , by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$sjg), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(-5.6,2.6 , by = 0.1), 
            opacity = 0.5, title = "Besag",
            position = "topright")





# Posterior means of the total spatial effect for Malaria (quntile)


map_2$tsmq = r1$summary.random$b1$mean[22:42]+r1$summary.random$besagproper$mean

range(map_2$tsmq) 


library(leaflet)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(-5.6,2.6 , by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$tsmq), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(-5.6,2.6 , by = 0.1), 
            opacity = 0.5, title = " Total spatial effect",
            position = "topright")




# Posterior means of the total spatial effect for g6pd (quntile)

map_2$tsgq = r1$summary.random$b2$mean[22:42]+r1$summary.random$Besag.c$mean

range(map_2$tsgq) 


l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(-5.6,2.6 , by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$tsgq ), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(-5.6,2.6 , by = 0.1), 
            opacity = 0.5, title = " Total spatial effect",
            position = "topright")


# RR for malaria from joint quantile 



map_2$rrjm = r1$summary.fitted.values[1:21, "mean"]/map_2$M.E

range(map_2$rrjm) 


library(leaflet)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(0,6.3, by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$rrjm), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(0,6.3, by = 0.1), 
            opacity = 0.5, title = "RR",
            position = "topright")

# rr from joint for d

map_2$rrjd = r1$summary.fitted.values[22:42, "mean"]/map_2$D.E

range(map_2$rrjd) 


library(leaflet)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(0,6.3, by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$rrjd), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(0,6.3, by = 0.1), 
            opacity = 0.5, title = "RR",
            position = "topright")




# The predicted cases for m from joint




map_2$pm = r1$summary.fitted.values$mean[1:21]

range(map_2$pm) 


library(leaflet)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(0,40000, length =9))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$pm), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(0,40000, length =9), 
            opacity = 0.5, title = "Predicted",
            position = "topright")


l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(0,40000, length =9))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$M.cases), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(0,40000, length =9), 
            opacity = 0.5, title = "Observed",
            position = "topright")


# The predicted cases for d from joint


map_2$pd = r1$summary.fitted.values$mean[22:42]
range(map_2$pd) 

# map_2$pd1 = exp(r$summary.linear.predictor$mean[22:42])
# range(map_2$pd1)

library(leaflet)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(0,500, length =9))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$pd), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(0,500, length =9), 
            opacity = 0.5, title = "Predicted",
            position = "topright")

#Observed

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain =seq(0,500, length =9))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$D.cases), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~ seq(0,500, length =9), 
            opacity = 0.5, title = "Observed",
            position = "topright")


# bym malaria from joint 

map_2$bymmq = r1$summary.random$b1$mean[1:21]

range(map_2$bymmq)


library(leaflet)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain = seq(-5.6,2.6 , by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$bymmq), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~seq(-5.6,2.6 , by = 0.1), 
            opacity = 0.5, title = "BYM effect for Malaria",
            position = "bottomleft")





# bym g6pd from joint 

map_2$bymgq = r1$summary.random$b2$mean[1:21]

range(map_2$bymgq)

l <- leaflet(map_2) %>% addTiles()

pal <- colorNumeric(palette = "YlOrRd", domain = seq(-5.6,2.6 , by = 0.1))


l %>% addPolygons(color = "grey", weight = 1, 
                  fillColor = ~pal(map_2$bymgq), 
                  fillOpacity = 0.5) %>%
  addLegend(pal = pal, values = ~seq(-5.6,2.6 , by = 0.1), 
            opacity = 0.5, title = "BYM effect for G6PD",
            position = "topright")



```


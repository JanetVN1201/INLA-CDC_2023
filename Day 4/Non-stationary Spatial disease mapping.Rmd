---
title: "Advancing public health and data science using INLA - Day 2"
author: "Janet van Niekerk (janet.vanNiekerk@kaust.edu.sa)"
output: html_document
date: "May 2024"
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "/Users/vanniej/Documents/GitHub/INLA-CDC_2023")

library("INLA")
library("DiagrammeR")
library("car")
library("ggpubr")
library("spdep")
library("RColorBrewer")
library("spatstat")
library("rgdal")
library("sp")
library("maptools")
library("latticeExtra")
library("gridExtra")
library("gstat")
library("raster")
library("ggplot2")
library("ggfortify")
library("survival")
library("joineR")
#library("bayesSurv")
library("BayesSurvival")
library("icenReg")
library("nloptr")
library("faraway")
library("lme4")
library("boot")
library("rnaturalearth")
library("leaflet")
library("viridis")
library("ggthemes")
```

## Non-stationary Besag model for areal data
*** overleaf material


## Example 
```{r Exa}


#######################-------------------#######################
#------------------------Functions-------------------------------
#######################-------------------#######################

'inla.rgeneric.fbesag.model' <- function(
    cmd = c("graph", "Q", "mu", "initial", "log.norm.const",
            "log.prior", "quit"),
    theta = NULL) {
  
  sbesag <- function(R, prec, id_p, scaled_cnst, npart){
    
    get_ij <- function(g){
      
      ii <- c(); jj <- c()
      for(i in 1:g$n){
        ii <- c(ii,rep(i,g$nnbs[i]), i)
        jj <- c(jj,g$nbs[[i]], i)
      }
      return(list(i=ii,j=jj))
    }
    
    g <- inla.read.graph(R)
    
    x_scaled = c()
    for(i in 1:g$n){
      tmp <- -0.5*prec[c(id_p[g$nbs[[i]]])]
      mas_prec <- prec[id_p[i]]
      x_scaled <- c(x_scaled, tmp - 0.5*mas_prec, -sum(tmp) + 0.5*g$nnbs[i]*mas_prec + 1e-5)
    }
    r <- get_ij(g)
    return(sparseMatrix(i = r$i, j = r$j, x = scaled_cnst*x_scaled))
  }
  
  npart <- length(unique(id_p))
  dim_theta <- npart
  
  interpret.theta <- function() {
    res <- list()
    for(i in 1:dim_theta){
      res[[i]] = exp(theta[i])
    }
    return(res)
  }
  
  graph <- function(){
    require(Matrix)
    return(Matrix(W,sparse=TRUE))
  }
  
  Q <- function() {
    res <- interpret.theta()
    prec = c()
    for(i in 1:dim_theta){
      prec = c(prec, res[[i]])
    }
    
    myR <- sbesag(W, prec, id_p, scaled_cnst=scaled_cnst, npart)
    return(inla.as.sparse(myR))
  }
  
  mu <- function(){return(numeric(0))}
  
  log.norm.const <- function() {
    return (numeric(0))
  }
  
  log.prior <- function() {
    
    #p1 = 1; p2 = 1e-5 
    p1 = 0.5; p2 = 0.01
    
    lam <- - log(p2)/p1
    res <- interpret.theta()
    prec = c()
    for(i in 1:dim_theta){
      prec = c(prec, res[[i]])
    }
    
    theta_p = log(prec)
    sigm2 <- sd_sim^2
    
    mean_theta <- mean(theta_p)
    P = npart
    e = eigen(diag(P) - (1/P)*matrix(1,P,P))
    D = diag(c(1.0/e$values[1:(P-1)]))
    inv_tilda_Sigma = (1/sigm2)*e$vectors[,1:(P-1)]%*%D%*%t(e$vectors[,1:(P-1)])
    
    res1 <- log(lam) - (lam)*exp(-0.5*mean_theta) -0.5*mean_theta
    res2 <- -0.5*(theta_p-mean_theta)%*%inv_tilda_Sigma%*%(theta_p-mean_theta)
    res <- drop(res1) + drop(res2) 
    return(res)
    
    
  }
  
  initial <- function() {
    #return(initial_theta)
    return(rep(4,npart))
  }
  
  quit <- function() {
    return(invisible())
  }
  
  res <- do.call(match.arg(cmd), args = list())
  return(res)
}

#######################-------------------#######################
#-------------------------Models--------------------------------
#######################-------------------#######################

load("Data/brazil.RData")

Six_terrestrial_biomes = TRUE

constr.inter <- list(A = matrix(1,1,dim(graph)[1]), e = rep(0, 1))
scaled_graph = as.matrix(INLA:::inla.scale.model(graph,constr.inter))
scaled_cnst = scaled_graph[1,1]/graph[1,1]

id_regions <- c()
if(Six_terrestrial_biomes){
  id_regions <- data$S4
  id_regions[which(id_regions==3)] = 2
  id_regions[which(id_regions==4)] = 3
  id_regions[which(id_regions==5)] = 4
  id_regions[which(id_regions==6)] = 5
}else{
  id_regions <- data$S3
}

precision.prior <- list(prec = list(prior = "pc.prec", param = c(0.5, 0.01)))
fbesag.model <- inla.rgeneric.define(inla.rgeneric.fbesag.model, W = graph, id_p = id_regions ,scaled_cnst = scaled_cnst, sd_sim = 0.15)

data$c_S1 <- data$S1
data$c_T1 <- data$T1

config = FALSE
baseformula <- Y ~ 1 + f(S1,model="generic0", Cmatrix= scaled_graph, constr= TRUE, rankdef = 1,hyper = precision.prior) +
                       f(T1, model = "rw1", constr = TRUE,  scale.model = TRUE, hyper =  list(prec = list(prior = "pc.prec", param = c(0.5, 0.01)))) #+
                     
formula     <- Y ~ 1 + f(S1, model = fbesag.model, constr= TRUE, rankdef=1) + 
                       f(T1, model = "rw1", constr = TRUE, scale.model = TRUE, hyper = precision.prior) 

model_naive <- inla(formula = baseformula, data = data, family = "poisson", offset = log(E),
                    control.inla = list(strategy = 'gaussian', int.strategy = "eb"), 
                    control.compute = list(dic = TRUE, config = config, 
                                           cpo = TRUE, return.marginals = FALSE, control.gcpo = list(enable = TRUE,num.level.sets = 2)),
                    control.fixed = list(correlation.matrix = TRUE, 
                                         prec.intercept = 1, prec = 1),
                    control.predictor = list(link = 1, compute = TRUE), 
                    verbose = TRUE)

model_fbesag <- inla(formula = formula, data = data, family = "poisson", offset = log(E),
                     control.inla = list(strategy = 'gaussian', int.strategy = "eb"), 
                     control.compute = list(dic = TRUE, config = config, 
                                            cpo = TRUE, return.marginals = FALSE, control.gcpo = list(enable = TRUE,num.level.sets = 2)),
                     control.fixed = list(correlation.matrix = TRUE, 
                                          prec.intercept = 1, prec = 1),
                     control.predictor = list(link = 1, compute = TRUE))

#######################-------------------#######################
#-------------------------Results--------------------------------
#######################-------------------#######################

results <- data.frame(
  Row = c("stationary", "non-stationary", "Better?"),
  DIC = c(0, 0, 0),
  CPO = c(0, 0, 0),
  GCPO = c(0, 0, 0),
  logML = c(0, 0, 0),
  MAE = c(0, 0, 0)
)

#DIC
round(model_fbesag$dic$dic,0) < round(model_naive$dic$dic,0)
round(model_fbesag$dic$dic,0) - round(model_naive$dic$dic,0)

cat(round(model_fbesag$dic$dic,0), " and ", round(model_naive$dic$dic,0))
results$DIC[1] <- round(model_naive$dic$dic,0)
results$DIC[2] <- round(model_fbesag$dic$dic,0)
results$DIC[3] <- round(model_fbesag$dic$dic,0) < round(model_naive$dic$dic,0)

#logML
model_fbesag$mlik[1] > model_naive$mlik[1]
model_fbesag$mlik[1] - model_naive$mlik[1]
cat(model_fbesag$mlik[1], " and ", model_naive$mlik[1])
results$logML[1] <- model_naive$mlik[1]
results$logML[2] <- model_fbesag$mlik[1]
results$logML[3] <- model_fbesag$mlik[1] > model_naive$mlik[1]

#gcpo
-mean(log(model_fbesag$gcpo$gcpo[model_naive$gcpo$gcpo>0])) < -mean(log(model_naive$gcpo$gcpo[model_naive$gcpo$gcpo>0])) 
cat(-mean(log(model_fbesag$gcpo$gcpo[model_naive$gcpo$gcpo>0])), " and ", -mean(log(model_naive$gcpo$gcpo[model_naive$gcpo$gcpo>0])) )
-mean(log(model_fbesag$cpo$cpo[model_naive$cpo$cpo>0])) < -mean(log(model_naive$cpo$cpo[model_naive$cpo$cpo>0])) 
results$GCPO[1] <- -mean(log(model_naive$gcpo$gcpo[model_naive$gcpo$gcpo>0])) 
results$GCPO[2] <- -mean(log(model_fbesag$gcpo$gcpo[model_naive$gcpo$gcpo>0]))
results$GCPO[3] <- -mean(log(model_fbesag$gcpo$gcpo[model_naive$gcpo$gcpo>0])) < -mean(log(model_naive$gcpo$gcpo[model_naive$gcpo$gcpo>0])) 

results$CPO[1] <- -mean(log(model_naive$cpo$cpo[model_naive$cpo$cpo>0])) 
results$CPO[2] <- -mean(log(model_fbesag$cpo$cpo[model_naive$cpo$cpo>0]))
results$CPO[3] <- -mean(log(model_fbesag$cpo$cpo[model_naive$cpo$cpo>0])) < -mean(log(model_naive$cpo$cpo[model_naive$cpo$cpo>0])) 

#MAE
data$fit_naive <- model_naive$summary.fitted.values$`0.5quant` 
data$fit_sbesag.model <- model_fbesag$summary.fitted.values$`0.5quant`
hydroGOF::mae(data$fit_naive, data$Y, na.rm = TRUE)
hydroGOF::mae(data$fit_sbesag.model, data$Y, na.rm = TRUE)

sum_mae_sbesag <- 0
sum_mae_naive <- 0

for(i in 1:5){
  sum_mae_naive <- sum_mae_naive + hydroGOF::mae(data$fit_naive[which(id_regions==i)], data$Y[which(id_regions==i)], na.rm = TRUE)
  sum_mae_sbesag <- sum_mae_sbesag + hydroGOF::mae(data$fit_sbesag.model[which(id_regions==i)], data$Y[which(id_regions==i)], na.rm = TRUE)
}
results$MAE[1] <- sum_mae_naive
results$MAE[2] <- sum_mae_sbesag
results$MAE[3] <- sum_mae_naive > sum_mae_sbesag

model_naive$internal.summary.hyperpar$mean
model_fbesag$internal.summary.hyperpar$mean

ch <- id_regions[1:558]
means <- numeric(5)
for(i in 1:5){
  means[i] <- mean(abs(model_fbesag$summary.random$S1$mean[ch==i] - model_naive$summary.random$S1$mean[ch==i]))
}

sum(model_fbesag$summary.random$S1$mean)
sum(model_naive$summary.random$S1$mean)
mean(abs(model_fbesag$summary.random$S1$mean - model_naive$summary.random$S1$mean))
f1_mean <- model_naive$internal.summary.hyperpar$mean[1]
f2_mean <- model_fbesag$internal.summary.hyperpar$mean[1:5]

f1_sd <- model_naive$internal.summary.hyperpar$sd[1]
f2_sd <- model_fbesag$internal.summary.hyperpar$sd[1:5]

#######################-------------------#######################
#--------------------- Print Results-----------------------------
#######################-------------------#######################

print(means)
print(mean(f1_mean) - mean(f2_mean))
print(mean(f1_sd) - mean(f2_sd))
print(results)
f1_mean - f2_mean
f1_sd - f2_sd





#######################-------------------#######################
#------------------------- Partitions ---------------------------
#######################-------------------#######################

library(viridis)

neigh_graphs <- poly2nb(as(map_df$geometry, "Spatial"), queen = FALSE)
values <- numeric(558)
values <- as.numeric(data$S3[1:558])

# Define custom color palette
custom_palette <- c("#f7776d", "#ffc000", "#2b8ab1", "#bbcf33", "#e76cf2")#, "#03be7d")

# Convert values to factor
values <- factor(values, levels = unique(values))

gplot <- ggplot(map_df) +
  geom_sf(aes(fill = values), lwd = 0) +
  labs(fill = "") +
  theme_void() +
  scale_fill_manual(
    values = custom_palette,
    breaks = unique(values),
    labels = c("North", "Northeast", "Southeast", "South", "Central-West")
  )

if(Six_terrestrial_biomes){
  ggsave(gplot, filename = "figs/Six_terrestrial_biomes/six_partitions.pdf", height = 4, width = 5)
}else{
  ggsave(gplot, filename = "figs/administrative_regions/five_partitions.pdf", height = 4, width = 5)
  
}


#######################-------------------#######################
#------------------------- Plots --------------------------------
#######################-------------------#######################

neigh_graphs = poly2nb(as(map_df$geometry, "Spatial"), queen = FALSE)
values <- numeric(558)
diff_m1 <- c(model_fbesag$internal.summary.hyperpar$mean[1:5]) - c(model_naive$internal.summary.hyperpar$mean[1])
for(i in 1:558) values[i] <- mean(diff_m1[id_regions[neigh_graphs[[i]]]])

gplot <- ggplot(map_df) +
  geom_sf(aes(fill = values), lwd = 0) +
  scale_fill_gradient_tableau("Blue-Teal") +
  labs(fill = "difference") +
  theme_void()  #+ scale_fill_discrete(type = "viridis", name = "", labels = c("Caatinga", "Cerrado", "Pantanal", "Pampas", "Amazon", "Atlantic Rainforest"))

if(Six_terrestrial_biomes){
  ggsave(gplot, filename = "figs/Six_terrestrial_biomes/diff_means_6_partitions.pdf", height = 4, width = 5)
}else{
  ggsave(gplot, filename = "figs/administrative_regions/diff_means_5_partitions.pdf", height = 4, width = 5)
}


neigh_graphs = poly2nb(as(map_df$geometry, "Spatial"), queen = FALSE)
values <- numeric(558)
diff_m1 <- c(model_fbesag$internal.summary.hyperpar$sd[1:5]) - c(model_naive$internal.summary.hyperpar$sd[1])
for(i in 1:558) values[i] <- mean(diff_m1[id_regions[neigh_graphs[[i]]]])

gplot <- ggplot(map_df) +
  geom_sf(aes(fill = values), lwd = 0) +
  scale_fill_gradient_tableau("Blue-Teal") +
  labs(fill = "spatial variability") +
  theme_void()  #+ scale_fill_discrete(type = "viridis", name = "", labels = c("Caatinga", "Cerrado", "Pantanal", "Pampas", "Amazon", "Atlantic Rainforest"))

values <- numeric(558)
diff_m1 <- model_fbesag$internal.summary.hyperpar$mean[1:5]
for(i in 1:558) values[i] <- mean(diff_m1[id_regions[neigh_graphs[[i]]]])

gplot <- ggplot(map_df) +
  geom_sf(aes(fill = values), lwd = 0) +
  scale_fill_gradient_tableau("Blue-Teal") +
  labs(fill = "spatial effect") +
  theme_void()  



  
##--> on time:
# time_graph <- as.matrix(INLA:::inla.rw(length(unique(data$T1)), order = 1, scale = FALSE))
# constr.inter <- list(A = matrix(1,1,dim(time_graph)[1]), e = rep(0, 1))
# scaled_graph = as.matrix(inla.scale.model(time_graph,constr.inter))
# scaled_cnst = scaled_graph[1,1]/graph[1,1]
# fbesag.time.model <- inla.rgeneric.define(inla.rgeneric.fbesag.model, W = time_graph, id_p = data$T1 ,scaled_cnst = scaled_cnst, sd_sim = 0.15)
#f(T1, model = fbesag.time.model, constr= TRUE, rankdef=1)







```
